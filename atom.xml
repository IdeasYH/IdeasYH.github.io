<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://https://github.com/IdeasYH/IdeasYH.github.io</id>
    <title>Gridea</title>
    <updated>2020-10-24T09:03:35.657Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://https://github.com/IdeasYH/IdeasYH.github.io"/>
    <link rel="self" href="https://https://github.com/IdeasYH/IdeasYH.github.io/atom.xml"/>
    <subtitle>æ¸©æ•…è€ŒçŸ¥æ–°</subtitle>
    <logo>https://https://github.com/IdeasYH/IdeasYH.github.io/images/avatar.png</logo>
    <icon>https://https://github.com/IdeasYH/IdeasYH.github.io/favicon.ico</icon>
    <rights>All rights reserved 2020, Gridea</rights>
    <entry>
        <title type="html"><![CDATA[Springbootæºç å­¦ä¹ _å¯åŠ¨ç±»]]></title>
        <id>https://https://github.com/IdeasYH/IdeasYH.github.io/post/springboot-yuan-ma-xue-xi-_-qi-dong-lei/</id>
        <link href="https://https://github.com/IdeasYH/IdeasYH.github.io/post/springboot-yuan-ma-xue-xi-_-qi-dong-lei/">
        </link>
        <updated>2020-10-24T02:40:02.000Z</updated>
        <content type="html"><![CDATA[<h1 id="å…³äºå¯åŠ¨ç±»jarluncher">å…³äºå¯åŠ¨ç±»jarLuncher</h1>
<h5 id="æ¦‚è¿°">æ¦‚è¿°</h5>
<p>SpringBootç”Ÿæˆçš„jaråŒ…</p>
<p>â€‹	å½“ä½¿ç”¨java -jarå‘½ä»¤æ‰§è¡ŒSpring Bootåº”ç”¨çš„å¯æ‰§è¡Œjaræ–‡ä»¶æ—¶ï¼Œè¯¥å‘½ä»¤å¼•å¯¼æ ‡å‡†å¯æ‰§è¡Œçš„jaræ–‡ä»¶ï¼Œé€šè¿‡åœ¨jarä¸­<code>MANIFES.MF</code>æ‰¾åˆ°<code>Main-Class</code>ï¼Œä»¥<code>JarLauncher.java</code>ä¸ºå…¥å£ï¼ŒåŠ è½½æ‰€æœ‰çš„éœ€è¦çš„å¯åŠ¨èµ„æºï¼ˆ<code>BOOT-INF/classes/*ï¼ŒBOOT-INF/lib/*</code>ï¼‰ï¼Œäº¤ç»™è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ï¼Œç„¶åé€šè¿‡åå°„ï¼Œå¯åŠ¨<code>MANIFES.MF</code>ä¸­å®šä¹‰çš„<code>Start-Class</code>çš„<code>main()</code>æ–¹æ³•ï¼Œå³åº”ç”¨å¯åŠ¨ç±»çš„<code>main()</code>æ–¹æ³•ã€‚</p>
<p>â€‹	SpringBoot çš„å¯æ‰§è¡ŒjaråŒ…åˆç§°fat jar ï¼Œæ˜¯åŒ…å«æ‰€æœ‰ä¾èµ–çš„ jar åŒ…ï¼Œjar åŒ…ä¸­åµŒå…¥äº†é™¤ java è™šæ‹Ÿæœºä»¥å¤–çš„æ‰€æœ‰ä¾èµ–ï¼Œæ˜¯ä¸€ä¸ª all-in-one jar åŒ…ã€‚æ™®é€šæ’ä»¶maven-jar-pluginç”Ÿæˆçš„åŒ…å’Œspring-boot-maven-pluginç”Ÿæˆçš„åŒ…ä¹‹é—´çš„ç›´æ¥åŒºåˆ«ï¼Œæ˜¯fat jarä¸­ä¸»è¦å¢åŠ äº†ä¸¤éƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†æ˜¯libç›®å½•ï¼Œå­˜æ”¾çš„æ˜¯Mavenä¾èµ–çš„jaråŒ…æ–‡ä»¶,ç¬¬äºŒéƒ¨åˆ†æ˜¯spring boot loaderç›¸å…³çš„ç±»ã€‚</p>
<p>â€‹	<font color = "ff0000">ä½†æ˜¯ç³»ç»Ÿè‡ªå¸¦çš„AppClassLoarderä¸æ”¯æŒè¯»å–åµŒå¥—jaråŒ…,å¼•å…¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨å°±æ˜¯ä¸ºäº†èƒ½è§£å†³jaråŒ…åµŒå¥—jaråŒ…çš„é—®é¢˜,äºæ˜¯springbootå°†è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨æ”¾åœ¨æœ€é¡¶æˆç›®å½•,ä½¿å®ƒå¯ä»¥è¢«åŠ è½½.</font></p>
<img src="C:\Users\idea\AppData\Roaming\Typora\typora-user-images\image-20201024110331302.png" alt="image-20201024110331302" style="zoom: 67%;" />
<h5 id="ä¸ºä»€ä¹ˆspringbootè¦å°†loader-ç±»ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å¤åˆ¶å‡ºæ¥å‘¢">ä¸ºä»€ä¹ˆSpringBootè¦å°†Loader ç±»ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å¤åˆ¶å‡ºæ¥å‘¢</h5>
<p>å¦‚æœå°†SpringBoot Class Loader ä¹Ÿæ”¾åˆ°libæ–‡ä»¶ä¸‹ï¼Œæ˜¯æ ¹æœ¬æ— æ³•è¢«åŠ è½½åˆ°çš„ï¼Œå› ä¸ºå®ƒæ ¹æœ¬ä¸ç¬¦åˆjaræ–‡ä»¶çš„ä¸€ä¸ªæ ‡å‡†è§„èŒƒ.</p>
<p>ç¨‹åºè¦æœ‰ä¸€ä¸ªå¯åŠ¨å…¥å£ï¼Œè¿™ä¸ªå…¥å£è¦ç”±åº”ç”¨ç±»åŠ è½½å™¨åŠ è½½ï¼Œå…ˆå°†SpringBoot Class LoaderåŠ è½½åˆ°å†…å­˜ä¸­ï¼Œç„¶åé€šè¿‡åç»­çš„ä¸€äº›æ“ä½œåˆ›å»ºçº¿ç¨‹ä¸Šä¸‹æ–‡åŠ è½½å™¨ï¼Œå»åŠ è½½ç¬¬ä¸‰æ–¹jarã€‚</p>
<h2 id="1-maven">1 Maven</h2>
<p>ä¹Ÿå°±æ˜¯è¯´æƒ³è¦çŸ¥é“<code>fat jar</code>æ˜¯å¦‚ä½•ç”Ÿæˆçš„ï¼Œå°±å¿…é¡»çŸ¥é“<code>spring-boot-maven-plugin</code>å·¥ä½œæœºåˆ¶ï¼Œè€Œ<code>spring-boot-maven-plugin</code>å±äºè‡ªå®šä¹‰æ’ä»¶ï¼Œå› æ­¤æˆ‘ä»¬åˆå¿…é¡»çŸ¥é“ï¼Œ<strong>Mavençš„è‡ªå®šä¹‰æ’ä»¶æ˜¯å¦‚ä½•å·¥ä½œçš„</strong></p>
<h5 id="mavençš„è‡ªå®šä¹‰æ’ä»¶">Mavençš„è‡ªå®šä¹‰æ’ä»¶</h5>
<p>Maven æ‹¥æœ‰ä¸‰å¥—ç›¸äº’ç‹¬ç«‹çš„ç”Ÿå‘½å‘¨æœŸ: <strong>clean</strong>ã€<strong>default</strong> å’Œ <strong>site</strong>, è€Œæ¯ä¸ªç”Ÿå‘½å‘¨æœŸåŒ…å«ä¸€äº›<strong>phase</strong>é˜¶æ®µ, é˜¶æ®µæ˜¯æœ‰é¡ºåºçš„, å¹¶ä¸”åé¢çš„é˜¶æ®µä¾èµ–äºå‰é¢çš„é˜¶æ®µã€‚ç”Ÿå‘½å‘¨æœŸçš„é˜¶æ®µ<strong>phase</strong>ä¸æ’ä»¶çš„ç›®æ ‡<strong>goal</strong>ç›¸äº’ç»‘å®šï¼Œç”¨ä»¥å®Œæˆå®é™…çš„æ„å»ºä»»åŠ¡ã€‚</p>
<pre><code class="language-xml">&lt;plugin&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
    &lt;executions&gt;
        &lt;execution&gt;
            &lt;goals&gt;
                &lt;goal&gt;repackage&lt;/goal&gt;
            &lt;/goals&gt;
        &lt;/execution&gt;
    &lt;/executions&gt;
&lt;/plugin&gt;
</code></pre>
<p><code>repackage</code>ç›®æ ‡å¯¹åº”çš„å°†æ‰§è¡Œåˆ°<code>org.springframework.boot.maven.RepackageMojo#execute</code>ï¼Œè¯¥æ–¹æ³•çš„ä¸»è¦é€»è¾‘æ˜¯è°ƒç”¨äº†<code>org.springframework.boot.maven.RepackageMojo#repackage</code></p>
<pre><code class="language-Java">private void repackage() throws MojoExecutionException {
     //è·å–ä½¿ç”¨maven-jar-pluginç”Ÿæˆçš„jarï¼Œæœ€ç»ˆçš„å‘½åå°†åŠ ä¸Š.orignalåç¼€
   Artifact source = getSourceArtifact();
    //æœ€ç»ˆæ–‡ä»¶ï¼Œå³Fat jar
   File target = getTargetFile();
    //è·å–é‡æ–°æ‰“åŒ…å™¨ï¼Œå°†é‡æ–°æ‰“åŒ…æˆå¯æ‰§è¡Œjaræ–‡ä»¶
   Repackager repackager = getRepackager(source.getFile());
    //æŸ¥æ‰¾å¹¶è¿‡æ»¤é¡¹ç›®è¿è¡Œæ—¶ä¾èµ–çš„jar
   Set&lt;Artifact&gt; artifacts = filterDependencies(this.project.getArtifacts(),
         getFilters(getAdditionalFilters()));
    //å°†artifactsè½¬æ¢æˆlibraries
   Libraries libraries = new ArtifactsLibraries(artifacts, this.requiresUnpack,
         getLog());
   try {
       //æä¾›Spring Bootå¯åŠ¨è„šæœ¬
      LaunchScript launchScript = getLaunchScript();
       //æ‰§è¡Œé‡æ–°æ‰“åŒ…é€»è¾‘ï¼Œç”Ÿæˆæœ€åfat jar
      repackager.repackage(target, libraries, launchScript);
   }
   catch (IOException ex) {
      throw new MojoExecutionException(ex.getMessage(), ex);
   }
    //å°†sourceæ›´æ–°æˆ xxx.jar.orignalæ–‡ä»¶
   updateArtifact(source, target, repackager.getBackupFile());
}
</code></pre>
<p>æˆ‘ä»¬å…³å¿ƒä¸€ä¸‹<code>org.springframework.boot.maven.RepackageMojo#getRepackager</code>è¿™ä¸ªæ–¹æ³•ï¼ŒçŸ¥é“<code>Repackager</code>æ˜¯å¦‚ä½•ç”Ÿæˆçš„ï¼Œä¹Ÿå°±å¤§è‡´èƒ½å¤Ÿæ¨æµ‹å‡ºå†…åœ¨çš„æ‰“åŒ…é€»è¾‘ã€‚</p>
<pre><code class="language-Java">private Repackager getRepackager(File source) {
   Repackager repackager = new Repackager(source, this.layoutFactory);
   repackager.addMainClassTimeoutWarningListener(
         new LoggingMainClassTimeoutWarningListener());
    //è®¾ç½®main classçš„åç§°ï¼Œå¦‚æœä¸æŒ‡å®šçš„è¯åˆ™ä¼šæŸ¥æ‰¾ç¬¬ä¸€ä¸ªåŒ…å«mainæ–¹æ³•çš„ç±»ï¼Œrepackeæœ€åå°†ä¼šè®¾ç½®org.springframework.boot.loader.JarLauncher
   repackager.setMainClass(this.mainClass);
   if (this.layout != null) {
      getLog().info(&quot;Layout: &quot; + this.layout);
       //é‡ç‚¹å…³å¿ƒä¸‹layout æœ€ç»ˆè¿”å›äº† org.springframework.boot.loader.tools.Layouts.Jar
      repackager.setLayout(this.layout.layout());
   }
   return repackager;
}
/**
 * Executable JAR layout.
 */
public static class Jar implements RepackagingLayout {
   @Override
   public String getLauncherClassName() {
      return &quot;org.springframework.boot.loader.JarLauncher&quot;;
   }
   @Override
   public String getLibraryDestination(String libraryName, LibraryScope scope) {
      return &quot;BOOT-INF/lib/&quot;;
   }
   @Override
   public String getClassesLocation() {
      return &quot;&quot;;
   }
   @Override
   public String getRepackagedClassesLocation() {
      return &quot;BOOT-INF/classes/&quot;;
   }
   @Override
   public boolean isExecutable() {
      return true;
   }
}
</code></pre>
<p><code>layout</code>æˆ‘ä»¬å¯ä»¥å°†ä¹‹ç¿»è¯‘ä¸ºæ–‡ä»¶å¸ƒå±€ï¼Œæˆ–è€…ç›®å½•å¸ƒå±€ï¼Œä»£ç ä¸€çœ‹æ¸…æ™°æ˜äº†ï¼ŒåŒæ—¶æˆ‘ä»¬éœ€è¦å…³æ³¨ï¼Œä¹Ÿæ˜¯ä¸‹ä¸€ä¸ªé‡ç‚¹å…³æ³¨å¯¹è±¡<code>org.springframework.boot.loader.JarLauncher</code>ï¼Œä»åå­—æ¨æ–­ï¼Œè¿™å¾ˆå¯èƒ½æ˜¯è¿”å›å¯æ‰§è¡Œ<code>jar</code>æ–‡ä»¶çš„å¯åŠ¨ç±»ã€‚</p>
<h5 id="manifestmfæ–‡ä»¶å†…å®¹">MANIFEST.MFæ–‡ä»¶å†…å®¹</h5>
<pre><code class="language-json">Manifest-Version: 1.0
Start-Class: com.shengsiyuan.boot.MyApplication
Main-Class: org.springframework.boot.loader.JarLauncher
</code></pre>
<p><code>repackager</code>ç”Ÿæˆçš„MANIFEST.MFæ–‡ä»¶ä¸ºä»¥ä¸Šä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°ä¸¤ä¸ªå…³é”®ä¿¡æ¯<code>Main-Class</code>å’Œ<code>Start-Class</code>ã€‚æˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥ï¼Œç¨‹åºçš„å¯åŠ¨å…¥å£å¹¶ä¸æ˜¯æˆ‘ä»¬SpringBootä¸­å®šä¹‰çš„<code>main</code>ï¼Œè€Œæ˜¯<code>JarLauncher#main</code>ï¼Œè€Œå†åœ¨å…¶ä¸­åˆ©ç”¨åå°„è°ƒç”¨å®šä¹‰å¥½çš„<code>Start-Class</code>çš„<code>main</code>æ–¹æ³•</p>
<h5 id="jarlauncher">JarLauncher</h5>
<h5 id="é‡ç‚¹ç±»ä»‹ç»">é‡ç‚¹ç±»ä»‹ç»</h5>
<ul>
<li>
<p><code>java.util.jar.JarFile</code> JDKå·¥å…·ç±»æä¾›çš„è¯»å–<code>jar</code>æ–‡ä»¶</p>
</li>
<li>
<p><code>org.springframework.boot.loader.jar.JarFile</code>Springboot-loader ç»§æ‰¿JDKæä¾›<code>JarFile</code>ç±»</p>
</li>
<li>
<p><code>java.util.jar.JarEntry</code>DKå·¥å…·ç±»æä¾›çš„``jar```æ–‡ä»¶æ¡ç›®</p>
</li>
<li>
<p><code>org.springframework.boot.loader.jar.JarEntry</code> Springboot-loader ç»§æ‰¿JDKæä¾›<code>JarEntry</code>ç±»</p>
</li>
<li>
<pre><code>org.springframework.boot.loader.archive.Archive
</code></pre>
<p>SpringbootæŠ½è±¡å‡ºæ¥çš„ç»Ÿä¸€è®¿é—®èµ„æºçš„å±‚</p>
<ul>
<li><code>JarFileArchive</code>jaråŒ…æ–‡ä»¶çš„æŠ½è±¡</li>
<li><code>ExplodedArchive</code>æ–‡ä»¶ç›®å½•</li>
</ul>
</li>
</ul>
<p>è¿™é‡Œé‡ç‚¹æè¿°ä¸€ä¸‹<code>JarFile</code>çš„ä½œç”¨ï¼Œæ¯ä¸ª<code>JarFileArchive</code>éƒ½ä¼šå¯¹åº”ä¸€ä¸ª<code>JarFile</code>ã€‚åœ¨æ„é€ çš„æ—¶å€™ä¼šè§£æå†…éƒ¨ç»“æ„ï¼Œå»è·å–<code>jar</code>åŒ…é‡Œçš„å„ä¸ª<strong>æ–‡ä»¶</strong>æˆ–<strong>æ–‡ä»¶å¤¹</strong>ç±»ã€‚æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹è¯¥ç±»çš„æ³¨é‡Šã€‚</p>
<pre><code>/* Extended variant of {@link java.util.jar.JarFile} that behaves in the same way but
* offers the following additional functionality.
* &lt;ul&gt;
* &lt;li&gt;A nested {@link JarFile} can be {@link #getNestedJarFile(ZipEntry) obtained} based
* on any directory entry.&lt;/li&gt;
* &lt;li&gt;A nested {@link JarFile} can be {@link #getNestedJarFile(ZipEntry) obtained} for
* embedded JAR files (as long as their entry is not compressed).&lt;/li&gt;
**/ &lt;/ul&gt;
</code></pre>
<p><code>jar</code>é‡Œçš„èµ„æºåˆ†éš”ç¬¦æ˜¯<code>!/</code>ï¼Œåœ¨JDKæä¾›çš„<code>JarFile</code> URLåªæ”¯æŒä¸€ä¸ªâ€™!/â€˜ï¼Œè€ŒSpring bootæ‰©å±•äº†è¿™ä¸ªåè®®ï¼Œè®©å®ƒæ”¯æŒå¤šä¸ªâ€™!/â€˜ï¼Œå°±å¯ä»¥è¡¨ç¤ºjar in jarã€jar in directoryã€fat jarçš„èµ„æºäº†ã€‚</p>
<h5 id="è‡ªå®šä¹‰ç±»åŠ è½½æœºåˆ¶">è‡ªå®šä¹‰ç±»åŠ è½½æœºåˆ¶</h5>
<ul>
<li>æœ€åŸºç¡€ï¼šBootstrap ClassLoaderï¼ˆåŠ è½½JDKçš„/libç›®å½•ä¸‹çš„ç±»ï¼‰</li>
<li>æ¬¡åŸºç¡€ï¼šExtension ClassLoaderï¼ˆåŠ è½½JDKçš„/lib/extç›®å½•ä¸‹çš„ç±»ï¼‰</li>
<li>æ™®é€šï¼šApplication ClassLoaderï¼ˆç¨‹åºè‡ªå·±classpathä¸‹çš„ç±»ï¼‰</li>
</ul>
<p>é¦–å…ˆéœ€è¦å…³æ³¨<strong>åŒäº²å§”æ´¾æœºåˆ¶</strong>å¾ˆé‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œå¦‚æœä¸€ä¸ªç±»å¯ä»¥è¢«å§”æ´¾æœ€åŸºç¡€çš„ClassLoaderåŠ è½½ï¼Œå°±ä¸èƒ½è®©é«˜å±‚çš„ClassLoaderåŠ è½½ï¼Œè¿™æ ·æ˜¯ä¸ºäº†èŒƒå›´é”™è¯¯çš„å¼•å…¥äº†éJDKä¸‹ä½†æ˜¯ç±»åä¸€æ ·çš„ç±»ã€‚å…¶äºŒï¼Œå¦‚æœåœ¨è¿™ä¸ªæœºåˆ¶ä¸‹ï¼Œç”±äº<code>fat jar</code>ä¸­ä¾èµ–çš„å„ä¸ª<code>jar</code>æ–‡ä»¶ï¼Œå¹¶ä¸åœ¨ç¨‹åºè‡ªå·±<code>classpath</code>ä¸‹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæˆ‘ä»¬é‡‡ç”¨åŒäº²å§”æ´¾æœºåˆ¶çš„è¯ï¼Œ<strong>æ ¹æœ¬è·å–ä¸åˆ°æˆ‘ä»¬æ‰€ä¾èµ–çš„jaråŒ…ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¿®æ”¹åŒäº²å§”æ´¾æœºåˆ¶çš„æŸ¥æ‰¾classçš„æ–¹æ³•ï¼Œè‡ªå®šä¹‰ç±»åŠ è½½æœºåˆ¶</strong>ã€‚</p>
<p>å…ˆç®€å•çš„ä»‹ç»Springboot2ä¸­<code>LaunchedURLClassLoader</code>ï¼Œè¯¥ç±»ç»§æ‰¿äº†<code>java.net.URLClassLoader</code>,é‡å†™äº†<code>java.lang.ClassLoader#loadClass(java.lang.String, boolean)</code>ï¼Œç„¶åæˆ‘ä»¬å†æ¢è®¨ä»–æ˜¯å¦‚ä½•ä¿®æ”¹åŒäº²å§”æ´¾æœºåˆ¶ã€‚</p>
<p>åœ¨ä¸Šé¢æˆ‘ä»¬è®²åˆ°Spring bootæ”¯æŒå¤šä¸ªâ€™!/â€˜ä»¥è¡¨ç¤ºå¤šä¸ªjarï¼Œè€Œæˆ‘ä»¬çš„é—®é¢˜åœ¨äºï¼Œå¦‚ä½•è§£å†³æŸ¥æ‰¾åˆ°è¿™å¤šä¸ªjaråŒ…ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹<code>LaunchedURLClassLoader</code>çš„æ„é€ æ–¹æ³•ã€‚</p>
<pre><code class="language-Java">public LaunchedURLClassLoader(URL[] urls, ClassLoader parent) {
   super(urls, parent);
}
</code></pre>
<p><strong><code>urls</code>æ³¨é‡Šè§£é‡Šé“<code>the URLs from which to load classes and resources</code>ï¼Œå³fat jaråŒ…ä¾èµ–çš„æ‰€æœ‰ç±»å’Œèµ„æºï¼Œå°†è¯¥<code>urls</code>å‚æ•°ä¼ é€’ç»™çˆ¶ç±»<code>java.net.URLClassLoader</code>ï¼Œç”±çˆ¶ç±»çš„<code>java.net.URLClassLoader#findClass</code>æ‰§è¡ŒæŸ¥æ‰¾ç±»æ–¹æ³•ï¼Œè¯¥ç±»çš„æŸ¥æ‰¾æ¥æºå³æ„é€ æ–¹æ³•ä¼ é€’è¿›æ¥çš„urlså‚æ•°</strong></p>
<pre><code class="language-Java">//LaunchedURLClassLoaderçš„å®ç°
protected Class&lt;?&gt; loadClass(String name, boolean resolve)
      throws ClassNotFoundException {
   Handler.setUseFastConnectionExceptions(true);
   try {
      try {
          //å°è¯•æ ¹æ®ç±»åå»å®šä¹‰ç±»æ‰€åœ¨çš„åŒ…ï¼Œå³java.lang.Packageï¼Œç¡®ä¿jar in jaré‡ŒåŒ¹é…çš„manifestèƒ½å¤Ÿå’Œå…³è”	           //çš„packageå…³è”èµ·æ¥
         definePackageIfNecessary(name);
      }
      catch (IllegalArgumentException ex) {
         // Tolerate race condition due to being parallel capable
         if (getPackage(name) == null) {
            // This should never happen as the IllegalArgumentException indicates
            // that the package has already been defined and, therefore,
            // getPackage(name) should not return null.
             
            //è¿™é‡Œå¼‚å¸¸è¡¨æ˜ï¼ŒdefinePackageIfNecessaryæ–¹æ³•çš„ä½œç”¨å®é™…ä¸Šæ˜¯é¢„å…ˆè¿‡æ»¤æ‰æŸ¥æ‰¾ä¸åˆ°çš„åŒ…
            throw new AssertionError(&quot;Package &quot; + name + &quot; has already been &quot;
                  + &quot;defined but it could not be found&quot;);
         }
      }
      return super.loadClass(name, resolve);
   }
   finally {
      Handler.setUseFastConnectionExceptions(false);
   }
}
</code></pre>
<p>æ–¹æ³•<code>super.loadClass(name, resolve)</code>å®é™…ä¸Šä¼šå›åˆ°äº†<code>java.lang.ClassLoader#loadClass(java.lang.String, boolean)</code>ï¼Œéµå¾ªåŒäº²å§”æ´¾æœºåˆ¶è¿›è¡ŒæŸ¥æ‰¾ç±»ï¼Œè€Œ<code>Bootstrap ClassLoader</code>å’Œ<code>Extension ClassLoader</code>å°†ä¼šæŸ¥æ‰¾ä¸åˆ°fat jarä¾èµ–çš„ç±»ï¼Œæœ€ç»ˆä¼šæ¥åˆ°<code>Application ClassLoader</code>ï¼Œè°ƒç”¨<code>java.net.URLClassLoader#findClass</code></p>
<h5 id="å¦‚ä½•çœŸæ­£çš„å¯åŠ¨">å¦‚ä½•çœŸæ­£çš„å¯åŠ¨</h5>
<p>Springboot2å’ŒSpringboot1çš„æœ€å¤§åŒºåˆ«åœ¨äºï¼ŒSpringboo1ä¼šæ–°èµ·ä¸€ä¸ªçº¿ç¨‹ï¼Œæ¥æ‰§è¡Œç›¸åº”çš„<strong>åå°„è°ƒç”¨é€»è¾‘</strong>ï¼Œè€ŒSpringBoot2åˆ™å»æ‰äº†æ„å»ºæ–°çš„çº¿ç¨‹è¿™ä¸€æ­¥ã€‚æ–¹æ³•æ˜¯<code>org.springframework.boot.loader.Launcher#launch(java.lang.String[], java.lang.String, java.lang.ClassLoader)</code>åå°„è°ƒç”¨é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œå°±ä¸å†åˆ†æï¼Œæ¯”è¾ƒå…³é”®çš„ä¸€ç‚¹æ˜¯ï¼Œåœ¨è°ƒç”¨<code>main</code>æ–¹æ³•ä¹‹å‰ï¼Œå°†å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨è®¾ç½®æˆ<code>LaunchedURLClassLoader</code></p>
<pre><code class="language-Java">protected void launch(String[] args, String mainClass, ClassLoader classLoader)
      throws Exception {
   Thread.currentThread().setContextClassLoader(classLoader);
   createMainMethodRunner(mainClass, args, classLoader).run();
}
</code></pre>
<h5 id="demo">Demo</h5>
<pre><code class="language-Java">public static void main(String[] args) throws ClassNotFoundException, MalformedURLException {
        JarFile.registerUrlProtocolHandler();
// æ„é€ LaunchedURLClassLoaderç±»åŠ è½½å™¨ï¼Œè¿™é‡Œä½¿ç”¨äº†2ä¸ªURLï¼Œåˆ†åˆ«å¯¹åº”jaråŒ…ä¸­ä¾èµ–åŒ…spring-boot-loaderå’Œspring-bootï¼Œä½¿ç”¨ &quot;!/&quot; åˆ†å¼€ï¼Œéœ€è¦org.springframework.boot.loader.jar.Handlerå¤„ç†å™¨å¤„ç†
        LaunchedURLClassLoader classLoader = new LaunchedURLClassLoader(
                new URL[] {
                        new URL(&quot;jar:file:/E:/IdeaProjects/oneday-auth/oneday-auth-server/target/oneday-auth-server-1.0.0-SNAPSHOT.jar!/BOOT-INF/lib/spring-boot-loader-1.2.3.RELEASE.jar!/&quot;)
                        , new URL(&quot;jar:file:/E:/IdeaProjects/oneday-auth/oneday-auth-server/target/oneday-auth-server-1.0.0-SNAPSHOT.jar!/BOOT-INF/lib/spring-boot-2.1.3.RELEASE.jar!/&quot;)
                },
                Application.class.getClassLoader());
// åŠ è½½ç±»
// è¿™2ä¸ªç±»éƒ½ä¼šåœ¨ç¬¬äºŒæ­¥æœ¬åœ°æŸ¥æ‰¾ä¸­è¢«æ‰¾å‡º(URLClassLoaderçš„findClassæ–¹æ³•)
        classLoader.loadClass(&quot;org.springframework.boot.loader.JarLauncher&quot;);
        classLoader.loadClass(&quot;org.springframework.boot.SpringApplication&quot;);
// åœ¨ç¬¬ä¸‰æ­¥ä½¿ç”¨é»˜è®¤çš„åŠ è½½é¡ºåºåœ¨ApplicationClassLoaderä¸­è¢«æ‰¾å‡º
   classLoader.loadClass(&quot;org.springframework.boot.autoconfigure.web.DispatcherServletAutoConfiguration&quot;);

//        SpringApplication.run(Application.class, args);
    }
</code></pre>
<h2 id="2å¯åŠ¨å™¨å®ç°åŸç†">2å¯åŠ¨å™¨å®ç°åŸç†</h2>
<p>Launcherçš„ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š<br>
<img src="C:\Users\idea\AppData\Roaming\Typora\typora-user-images\image-20201024114850040.png" alt="image-20201024114850040" style="zoom:67%;" /></p>
<h3 id="å¯åŠ¨ç±»jarlauncher"><strong>å¯åŠ¨ç±»ï¼šJarLauncher</strong></h3>
<pre><code class="language-java">//JarLauncher.java
public class JarLauncher extends ExecutableArchiveLauncher {

	static final String BOOT_INF_CLASSES = &quot;BOOT-INF/classes/&quot;;

	static final String BOOT_INF_LIB = &quot;BOOT-INF/lib/&quot;;

	public JarLauncher() {
	}

	protected JarLauncher(Archive archive) {
		super(archive);
	}

	@Override
	protected boolean isNestedArchive(Archive.Entry entry) {
		if (entry.isDirectory()) {
			return entry.getName().equals(BOOT_INF_CLASSES);
		}
		return entry.getName().startsWith(BOOT_INF_LIB);
	}

	public static void main(String[] args) throws Exception {
		new JarLauncher().launch(args);
	}
}
</code></pre>
<p>JarLauncheré»˜è®¤æ„é€ å‡½æ•°å®ç°ä¸ºç©ºï¼Œå®ƒçˆ¶ç±»ExecutableArchiveLauncherä¼šè°ƒç”¨å†ä¸Šä¸€çº§çˆ¶ç±»Launcherçš„createArchiveæ–¹æ³•åŠ è½½jaråŒ…, åŠ è½½äº†jaråŒ…ä¹‹åï¼Œæˆ‘ä»¬å°±èƒ½è·å–åˆ°é‡Œé¢æ‰€æœ‰çš„èµ„æºã€‚</p>
<pre><code class="language-java">	//JarLauncher.java
	
	//JarLauncheré»˜è®¤æ„é€ å‡½æ•°
	public JarLauncher() {
	}
	
//ExecutableArchiveLauncher.java	

public ExecutableArchiveLauncher() {
		try {
      //å¼€å§‹åŠ è½½jaråŒ…
			this.archive = createArchive();
		}
		catch (Exception ex) {
			throw new IllegalStateException(ex);
		}
	}
//Launcher.java	

protected final Archive createArchive() throws Exception {
    //é€šè¿‡è·å–å½“å‰Classç±»çš„ä¿¡æ¯ï¼ŒæŸ¥æ‰¾åˆ°å½“å‰å½’æ¡£æ–‡ä»¶çš„è·¯å¾„
		ProtectionDomain protectionDomain = getClass().getProtectionDomain();
		CodeSource codeSource = protectionDomain.getCodeSource();
		URI location = (codeSource != null) ? codeSource.getLocation().toURI() : null;
		String path = (location != null) ? location.getSchemeSpecificPart() : null;
		if (path == null) {
			throw new IllegalStateException(&quot;Unable to determine code source archive&quot;);
		}
    //è·å–åˆ°è·¯å¾„ä¹‹åï¼Œåˆ›å»ºå¯¹åº”çš„æ–‡ä»¶ï¼Œå¹¶æ£€æŸ¥æ˜¯å¦å­˜åœ¨
		File root = new File(path);
		if (!root.exists()) {
			throw new IllegalStateException(
					&quot;Unable to determine code source archive from &quot; + root);
		}
    //å¦‚æœæ˜¯ç›®å½•ï¼Œåˆ™åˆ›å»ºExplodedArchiveï¼Œå¦åˆ™åˆ›å»ºJarFileArchive
		return (root.isDirectory() ? new ExplodedArchive(root)
				: new JarFileArchive(root));
	}
</code></pre>
<h3 id="æ ¸å¿ƒæ–¹æ³•launchstring-args">æ ¸å¿ƒæ–¹æ³•ï¼šlaunch(String[] args)</h3>
<p>launchæ–¹æ³•å®é™…ä¸Šæ˜¯è°ƒç”¨çˆ¶ç±»Launcherçš„launchæ–¹æ³•</p>
<pre><code class="language-java">// Launcher.java	

protected void launch(String[] args) throws Exception {
    //æ³¨å†Œ Spring Boot è‡ªå®šä¹‰çš„ URLStreamHandler å®ç°ç±»ï¼Œç”¨äº jar åŒ…çš„åŠ è½½è¯»å–, å¯è¯»å–åˆ°å†…åµŒçš„jaråŒ…
		JarFile.registerUrlProtocolHandler();
    //åˆ›å»ºè‡ªå®šä¹‰çš„ ClassLoader å®ç°ç±»ï¼Œç”¨äºä» jar åŒ…ä¸­åŠ è½½ç±»ã€‚
		ClassLoader classLoader = createClassLoader(getClassPathArchives());
    //æ‰§è¡Œæˆ‘ä»¬å£°æ˜çš„ Spring Boot å¯åŠ¨ç±»ï¼Œè¿›è¡Œ Spring Boot åº”ç”¨çš„å¯åŠ¨ã€‚
		launch(args, getMainClass(), classLoader);
	}
</code></pre>
<p>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯åˆ›å»ºä¸€ä¸ªå¯ä»¥è¯»å– <code>jar</code> åŒ…ä¸­ç±»çš„åŠ è½½å™¨ï¼Œä¿è¯ <code>BOOT-INF/lib</code> ç›®å½•ä¸‹çš„ç±»å’Œ <code>BOOT-classes</code> å†…åµŒçš„ <code>jar</code> ä¸­çš„ç±»èƒ½å¤Ÿè¢«æ­£å¸¸åŠ è½½åˆ°ï¼Œä¹‹åæ‰§è¡Œ Spring Boot åº”ç”¨çš„å¯åŠ¨ã€‚</p>
<h4 id="æ–¹æ³•ä¸€registerurlprotocolhandler">æ–¹æ³•ä¸€ï¼š<strong>registerUrlProtocolHandler</strong></h4>
<pre><code class="language-java">public static void registerUrlProtocolHandler() {
    	// è·å¾— URLStreamHandler çš„è·¯å¾„
		String handlers = System.getProperty(PROTOCOL_HANDLER, &quot;&quot;);
    	// å°† Spring Boot è‡ªå®šä¹‰çš„ HANDLERS_PACKAGE(org.springframework.boot.loader) è¡¥å……ä¸Šå»
		System.setProperty(PROTOCOL_HANDLER, (&quot;&quot;.equals(handlers) ? HANDLERS_PACKAGE
				: handlers + &quot;|&quot; + HANDLERS_PACKAGE));
    	// é‡ç½®å·²ç¼“å­˜çš„ URLStreamHandler å¤„ç†å™¨ä»¬
		resetCachedUrlHandlers();
	}
</code></pre>
<p>è¯¥æ–¹æ³•çš„ç›®çš„å°±æ˜¯é€šè¿‡å°† <code>org.springframework.boot.loader</code> åŒ…è®¾ç½®åˆ° <code>&quot;java.protocol.handler.pkgs&quot;</code> ç¯å¢ƒå˜é‡ï¼Œä»è€Œä½¿ç”¨åˆ°è‡ªå®šä¹‰çš„ URLStreamHandler å®ç°ç±» Handlerï¼Œå¤„ç† <code>jar:</code> åè®®çš„ URLã€‚</p>
<pre><code>åˆ©ç”¨java urlåè®®å®ç°æ‰©å±•åŸç†ï¼Œè‡ªå®šä¹‰jaråè®®
å°†org.springframework.boot.loaderåŒ… è¿½åŠ åˆ°javaç³»ç»Ÿ å±æ€§java.protocol.handler.pkgsä¸­ï¼Œå®ç°è‡ªå®šä¹‰jaråè®®

javaä¼šåœ¨java.protocol.handler.pkgsç³»ç»Ÿå±æ€§æŒ‡å®šçš„åŒ…ä¸­æŸ¥æ‰¾ä¸åè®®åŒåçš„å­åŒ…å’Œåä¸ºHandlerçš„ç±»ï¼Œ
å³è´Ÿè´£å¤„ç†å½“å‰åè®®çš„URLStreamHandlerå®ç°ç±»å¿…é¡»åœ¨ &lt;åŒ…å&gt;.&lt;åè®®åå®šä¹‰çš„åŒ…&gt; ä¸­ï¼Œå¹¶ä¸”ç±»åç§°å¿…é¡»ä¸ºHandler
ä¾‹å¦‚ï¼š
org.springframework.boot.loader.jar.Handlerè¿™ä¸ªç±» å°†ç”¨äºå¤„ç†jaråè®®

è¿™ä¸ªjaråè®®å®ç°ä½œç”¨ï¼š
é»˜è®¤æƒ…å†µä¸‹ï¼ŒJDKæä¾›çš„ClassLoaderåªèƒ½è¯†åˆ«jarä¸­çš„classæ–‡ä»¶ä»¥åŠåŠ è½½classpathä¸‹çš„å…¶ä»–jaråŒ…ä¸­çš„classæ–‡ä»¶ã€‚
å¯¹äºjaråŒ…ä¸­çš„jaråŒ…æ˜¯æ— æ³•åŠ è½½çš„
æ‰€ä»¥spring boot è‡ªå·±å®šä¹‰äº†ä¸€å¥—URLStreamHandlerå®ç°ç±»å’ŒJarURLConnectionå®ç°ç±»ï¼Œç”¨æ¥åŠ è½½jaråŒ…ä¸­çš„jaråŒ…çš„classç±»æ–‡ä»¶
</code></pre>
<p>ä¸¾ä¸ªä¾‹å­ï¼š</p>
<pre><code>jar:file:C:/Users/Administrator/Desktop/demo/demo/target/jarlauncher-0.0.1-SNAPSHOT.jar!/lib/spring-boot-1.5.10.RELEASE.jar!/

jar:file:C:/Users/Administrator/Desktop/demo/demo/target/jarlauncher-0.0.1-SNAPSHOT.jar!/lib/spring-boot-1.5.10.RELEASE.jar!/org/springframework/boot/loader/JarLauncher.class
123
</code></pre>
<p>æˆ‘ä»¬çœ‹åˆ°å¦‚æœæœ‰ jar åŒ…ä¸­åŒ…å« jarï¼Œæˆ–è€… jar åŒ…ä¸­åŒ…å« jar åŒ…é‡Œé¢çš„ class æ–‡ä»¶ï¼Œé‚£ä¹ˆä¼šä½¿ç”¨ !/åˆ†éš”å¼€ï¼Œè¿™ç§æ–¹å¼åªæœ‰ org.springframework.boot.loader.jar.Handler èƒ½å¤„ç†ï¼Œå®ƒæ˜¯ SpringBoot å†…éƒ¨æ‰©å±•å‡ºæ¥ä¸€ç§<strong>URLåè®®</strong>.</p>
<p>é€šå¸¸ï¼Œjaré‡Œçš„èµ„æºåˆ†éš”ç¬¦æ˜¯!/ï¼Œåœ¨JDKæä¾›çš„JarFile URLåªæ”¯æŒä¸€å±‚â€œ!/â€ï¼Œè€ŒSpring Bootæ‰©å±•äº†è¯¥åè®®ï¼Œå¯æ”¯æŒå¤šå±‚â€œ!/â€ã€‚</p>
<h4 id="æ–¹æ³•äºŒcreateclassloader">æ–¹æ³•äºŒï¼š<strong>createClassLoader</strong></h4>
<pre><code class="language-java">ClassLoader classLoader = createClassLoader(getClassPathArchives());
</code></pre>
<h5 id="getclasspatharchives">getClassPathArchivesï¼ˆï¼‰</h5>
<pre><code class="language-java">// ExecutableArchiveLauncher.java

@Override
protected List&lt;Archive&gt; getClassPathArchives() throws Exception {
 // &lt;1&gt; è·å¾—æ‰€æœ‰ Archive
 List&lt;Archive&gt; archives = new ArrayList&lt;&gt;(
   this.archive.getNestedArchives(this::isNestedArchive));
 // &lt;2&gt; åç»­å¤„ç†ï¼šæ˜¯ä¸ªç©ºæ–¹æ³•
 postProcessClassPathArchives(archives);
 return archives;
}
</code></pre>
<p><code>&lt;1&gt;</code> å¤„ï¼Œ<code>this::isNestedArchive</code> ä»£ç æ®µï¼Œåˆ›å»ºäº† EntryFilter åŒ¿åå®ç°ç±»ï¼Œç”¨äºè¿‡æ»¤ <code>jar</code> åŒ…ä¸éœ€è¦çš„ç›®å½•ã€‚ç›®çš„å°±æ˜¯è¿‡æ»¤è·å¾—ï¼Œ<code>BOOT-INF/classes/</code> ç›®å½•ä¸‹çš„ç±»ï¼Œä»¥åŠ <code>BOOT-INF/lib/</code> çš„å†…åµŒ <code>jar</code> åŒ…ã€‚</p>
<pre><code class="language-java">// JarLauncher.java

static final String BOOT_INF_CLASSES = &quot;BOOT-INF/classes/&quot;;

static final String BOOT_INF_LIB = &quot;BOOT-INF/lib/&quot;;

@Override
protected boolean isNestedArchive(Archive.Entry entry) {
    // å¦‚æœæ˜¯ç›®å½•çš„æƒ…å†µï¼Œåªè¦ BOOT-INF/classes/ ç›®å½•
 if (entry.isDirectory()) {
  return entry.getName().equals(BOOT_INF_CLASSES);
 }
 // å¦‚æœæ˜¯æ–‡ä»¶çš„æƒ…å†µï¼Œåªè¦ BOOT-INF/lib/ ç›®å½•ä¸‹çš„ `jar` åŒ…
 return entry.getName().startsWith(BOOT_INF_LIB);
}
</code></pre>
<p>&lt;1&gt;å¤„getNestedArchives()æ–¹æ³•å®ç°</p>
<pre><code class="language-java">	//JarFileArchive.java
	
	@Override
	public List&lt;Archive&gt; getNestedArchives(EntryFilter filter) throws IOException {
		List&lt;Archive&gt; nestedArchives = new ArrayList&lt;&gt;();
		for (Entry entry : this) {
			if (filter.matches(entry)) {
				nestedArchives.add(getNestedArchive(entry));
			}
		}
		return Collections.unmodifiableList(nestedArchives);
	}
</code></pre>
<h5 id="createclassloaderlist-archives">createClassLoader(List archives)</h5>
<pre><code class="language-java">// ExecutableArchiveLauncher.java

protected ClassLoader createClassLoader(List&lt;Archive&gt; archives) throws Exception {
 // è·å¾—æ‰€æœ‰ Archive çš„ URL åœ°å€
    List&lt;URL&gt; urls = new ArrayList&lt;&gt;(archives.size());
 for (Archive archive : archives) {
  urls.add(archive.getUrl());
 }
 // åˆ›å»ºåŠ è½½è¿™äº› URL çš„ ClassLoader
 return createClassLoader(urls.toArray(new URL[0]));
}

protected ClassLoader createClassLoader(URL[] urls) throws Exception {
 return new LaunchedURLClassLoader(urls, getClass().getClassLoader());
}
</code></pre>
<p>åŸºäºè·å¾—çš„ Archive æ•°ç»„ï¼Œåˆ›å»ºè‡ªå®šä¹‰ ClassLoader å®ç°ç±» LaunchedURLClassLoaderï¼Œé€šè¿‡å®ƒæ¥åŠ è½½ <code>BOOT-INF/classes</code> ç›®å½•ä¸‹çš„ç±»ï¼Œä»¥åŠ <code>BOOT-INF/lib</code> ç›®å½•ä¸‹çš„ <code>jar</code> åŒ…ä¸­çš„ç±»ã€‚</p>
<h4 id="æ–¹æ³•ä¸‰launchstring-args-string-mainclass-classloader-classloader">æ–¹æ³•ä¸‰ï¼šlaunch(String[] args, String mainClass, ClassLoader classLoader)</h4>
<p>ç»™å®šå­˜æ¡£æ–‡ä»¶å’Œå®Œå…¨é…ç½®çš„ç±»åŠ è½½å™¨ï¼Œå¯åŠ¨åº”ç”¨ç¨‹åºã€‚</p>
<pre><code class="language-java">launch(args, getMainClass(), classLoader);
protected void launch(String[] args, String mainClass, ClassLoader classLoader)
			throws Exception {
    	  // &lt;1&gt; è®¾ç½® LaunchedURLClassLoader ä½œä¸ºç±»åŠ è½½å™¨
		Thread.currentThread().setContextClassLoader(classLoader);
    	 // &lt;2&gt; åˆ›å»º MainMethodRunner å¯¹è±¡ï¼Œå¹¶æ‰§è¡Œ run æ–¹æ³•ï¼Œå¯åŠ¨ Spring Boot åº”ç”¨
		createMainMethodRunner(mainClass, args, classLoader).run();
	}
</code></pre>
<p><code>&lt;1&gt;</code> å¤„ï¼šè®¾ç½® LaunchedURLClassLoader ä½œä¸ºç±»åŠ è½½å™¨ï¼Œä»è€Œä¿è¯èƒ½å¤Ÿä» <code>jar</code> åŒ…ä¸­åŠ è½½åˆ°ç›¸åº”çš„ç±»ã€‚</p>
<h5 id="getmainclass"><strong>getMainClass()</strong></h5>
<pre><code class="language-java">// ExecutableArchiveLauncher.java

@Override
protected String getMainClass() throws Exception {
    // è·å¾—å¯åŠ¨çš„ç±»çš„å…¨å
 Manifest manifest = this.archive.getManifest();
 String mainClass = null;
 if (manifest != null) {
  mainClass = manifest.getMainAttributes().getValue(&quot;Start-Class&quot;);
 }
 if (mainClass == null) {
  throw new IllegalStateException(
    &quot;No 'Start-Class' manifest entry specified in &quot; + this);
 }
 return mainClass;
}
</code></pre>
<p>ä» <code>jar</code> åŒ…çš„ <code>MANIFEST.MF</code> æ–‡ä»¶çš„ <code>Start-Class</code> é…ç½®é¡¹ï¼Œï¼Œè·å¾—æˆ‘ä»¬è®¾ç½®çš„ Spring Boot çš„<strong>ä¸»</strong>å¯åŠ¨ç±»ã€‚</p>
<h5 id="createmainmethodrunner"><strong>createMainMethodRunner</strong></h5>
<pre><code class="language-java">protected MainMethodRunner createMainMethodRunner(String mainClass, String[] args,
			ClassLoader classLoader) {
		return new MainMethodRunner(mainClass, args);
	}
</code></pre>
<h5 id="run">run()</h5>
<pre><code class="language-java">public void run() throws Exception {
    // &lt;1&gt; åŠ è½½ Spring Boot
   Class&lt;?&gt; mainClass = Thread.currentThread().getContextClassLoader()
         .loadClass(this.mainClassName);
  // &lt;2&gt; åå°„è°ƒç”¨ main æ–¹æ³•
   Method mainMethod = mainClass.getDeclaredMethod(&quot;main&quot;, String[].class);
   mainMethod.invoke(null, new Object[] { this.args });
}
</code></pre>
<p>è¯¥æ–¹æ³•è´Ÿè´£æœ€ç»ˆçš„ Spring Boot åº”ç”¨çœŸæ­£çš„<strong>å¯åŠ¨</strong>ã€‚</p>
<h3 id="springbootè‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨-launchedurlclassloader">SpringBootè‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ï¼š <strong>LaunchedURLClassLoader</strong></h3>
<p>LaunchedURLClassLoader æ˜¯ <code>spring-boot-loader</code> é¡¹ç›®è‡ªå®šä¹‰çš„<strong>ç±»åŠ è½½å™¨</strong>ï¼Œå®ç°å¯¹ <code>jar</code> åŒ…ä¸­ <code>META-INF/classes</code> ç›®å½•ä¸‹çš„<strong>ç±»</strong>å’Œ <code>META-INF/lib</code> å†…åµŒçš„ <code>jar</code> åŒ…ä¸­çš„<strong>ç±»</strong>çš„<strong>åŠ è½½</strong>ã€‚</p>
<p>è¯¥ClassLoaderç»§æ‰¿è‡ªUrlClassLoaderã€‚UrlClassLoaderåŠ è½½classå°±æ˜¯ä¾é åˆå§‹å‚æ•°ä¼ å…¥çš„Urlæ•°ç»„ï¼Œå¹¶ä¸”å°è¯•ä»UrlæŒ‡å‘çš„èµ„æºä¸­åŠ è½½Classæ–‡ä»¶</p>
<pre><code class="language-java">//LaunchedURLClassLoader.java

protected Class&lt;?&gt; loadClass(String name, boolean resolve)
      throws ClassNotFoundException {
   Handler.setUseFastConnectionExceptions(true);
   try {
      try {
          //å°è¯•æ ¹æ®ç±»åå»å®šä¹‰ç±»æ‰€åœ¨çš„åŒ…ï¼Œå³java.lang.Packageï¼Œç¡®ä¿jar in jaré‡ŒåŒ¹é…çš„manifestèƒ½å¤Ÿå’Œå…³è”çš„packageå…³è”èµ·æ¥
         definePackageIfNecessary(name);
      }
      catch (IllegalArgumentException ex) {
         // Tolerate race condition due to being parallel capable
         if (getPackage(name) == null) {
            // This should never happen as the IllegalArgumentException indicates
            // that the package has already been defined and, therefore,
            // getPackage(name) should not return null.

            //è¿™é‡Œå¼‚å¸¸è¡¨æ˜ï¼ŒdefinePackageIfNecessaryæ–¹æ³•çš„ä½œç”¨å®é™…ä¸Šæ˜¯é¢„å…ˆè¿‡æ»¤æ‰æŸ¥æ‰¾ä¸åˆ°çš„åŒ…
            throw new AssertionError(&quot;Package &quot; + name + &quot; has already been &quot;
                  + &quot;defined but it could not be found&quot;);
         }
      }
      return super.loadClass(name, resolve);
   }
   finally {
      Handler.setUseFastConnectionExceptions(false);
   }
}
</code></pre>
<p>æ–¹æ³•super.loadClass(name, resolve)å®é™…ä¸Šä¼šå›åˆ°äº†java.lang.ClassLoader#loadClass(java.lang.String, boolean)ï¼Œéµå¾ªåŒäº²å§”æ´¾æœºåˆ¶è¿›è¡ŒæŸ¥æ‰¾ç±»ï¼Œè€ŒBootstrap ClassLoaderå’ŒExtension ClassLoaderå°†ä¼šæŸ¥æ‰¾ä¸åˆ°fat jarä¾èµ–çš„ç±»ï¼Œæœ€ç»ˆä¼šæ¥åˆ°Application ClassLoaderï¼Œè°ƒç”¨java.net.URLClassLoader#findClass</p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<ul>
<li>SpringBooté€šè¿‡æ‰©å±•JarFileã€JarURLConnectionåŠURLStreamHandlerï¼Œå®ç°äº†jar in jarä¸­èµ„æºçš„åŠ è½½</li>
<li>SpringBooté€šè¿‡æ‰©å±•URLClassLoader--LauncherURLClassLoaderï¼Œå®ç°äº†jar in jarä¸­classæ–‡ä»¶çš„åŠ è½½</li>
<li>JarLauncheré€šè¿‡åŠ è½½BOOT-INF/classesç›®å½•åŠBOOT-INF/libç›®å½•ä¸‹jaræ–‡ä»¶ï¼Œå®ç°äº†fat jarçš„å¯åŠ¨</li>
<li>WarLauncheré€šè¿‡åŠ è½½WEB-INF/classesç›®å½•åŠWEB-INF/libå’ŒWEB-INF/lib-providedç›®å½•ä¸‹çš„jaræ–‡ä»¶ï¼Œå®ç°äº†waræ–‡ä»¶çš„ç›´æ¥å¯åŠ¨åŠwebå®¹å™¨ä¸­çš„å¯åŠ¨</li>
</ul>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Hello Gridea]]></title>
        <id>https://https://github.com/IdeasYH/IdeasYH.github.io/post/hello-gridea/</id>
        <link href="https://https://github.com/IdeasYH/IdeasYH.github.io/post/hello-gridea/">
        </link>
        <updated>2018-12-11T16:00:00.000Z</updated>
        <summary type="html"><![CDATA[<p>ğŸ‘  æ¬¢è¿ä½¿ç”¨ <strong>Gridea</strong> ï¼<br>
âœï¸  <strong>Gridea</strong> ä¸€ä¸ªé™æ€åšå®¢å†™ä½œå®¢æˆ·ç«¯ã€‚ä½ å¯ä»¥ç”¨å®ƒæ¥è®°å½•ä½ çš„ç”Ÿæ´»ã€å¿ƒæƒ…ã€çŸ¥è¯†ã€ç¬”è®°ã€åˆ›æ„... ...</p>
]]></summary>
        <content type="html"><![CDATA[<p>ğŸ‘  æ¬¢è¿ä½¿ç”¨ <strong>Gridea</strong> ï¼<br>
âœï¸  <strong>Gridea</strong> ä¸€ä¸ªé™æ€åšå®¢å†™ä½œå®¢æˆ·ç«¯ã€‚ä½ å¯ä»¥ç”¨å®ƒæ¥è®°å½•ä½ çš„ç”Ÿæ´»ã€å¿ƒæƒ…ã€çŸ¥è¯†ã€ç¬”è®°ã€åˆ›æ„... ...</p>
<!-- more -->
<p><a href="https://github.com/getgridea/gridea">Github</a><br>
<a href="https://gridea.dev/">Gridea ä¸»é¡µ</a><br>
<a href="http://fehey.com/">ç¤ºä¾‹ç½‘ç«™</a></p>
<h2 id="ç‰¹æ€§">ç‰¹æ€§ğŸ‘‡</h2>
<p>ğŸ“  ä½ å¯ä»¥ä½¿ç”¨æœ€é…·çš„ <strong>Markdown</strong> è¯­æ³•ï¼Œè¿›è¡Œå¿«é€Ÿåˆ›ä½œ</p>
<p>ğŸŒ‰  ä½ å¯ä»¥ç»™æ–‡ç« é…ä¸Šç²¾ç¾çš„å°é¢å›¾å’Œåœ¨æ–‡ç« ä»»æ„ä½ç½®æ’å…¥å›¾ç‰‡</p>
<p>ğŸ·ï¸  ä½ å¯ä»¥å¯¹æ–‡ç« è¿›è¡Œæ ‡ç­¾åˆ†ç»„</p>
<p>ğŸ“‹  ä½ å¯ä»¥è‡ªå®šä¹‰èœå•ï¼Œç”šè‡³å¯ä»¥åˆ›å»ºå¤–éƒ¨é“¾æ¥èœå•</p>
<p>ğŸ’»  ä½ å¯ä»¥åœ¨ <strong>Windows</strong>ï¼Œ<strong>MacOS</strong> æˆ– <strong>Linux</strong> è®¾å¤‡ä¸Šä½¿ç”¨æ­¤å®¢æˆ·ç«¯</p>
<p>ğŸŒ  ä½ å¯ä»¥ä½¿ç”¨ <strong>ğ–¦ğ—‚ğ—ğ—ğ—ğ–» ğ–¯ğ–ºğ—€ğ–¾ğ—Œ</strong> æˆ– <strong>Coding Pages</strong> å‘ä¸–ç•Œå±•ç¤ºï¼Œæœªæ¥å°†æ”¯æŒæ›´å¤šå¹³å°</p>
<p>ğŸ’¬  ä½ å¯ä»¥è¿›è¡Œç®€å•çš„é…ç½®ï¼Œæ¥å…¥ <a href="https://github.com/gitalk/gitalk">Gitalk</a> æˆ– <a href="https://github.com/SukkaW/DisqusJS">DisqusJS</a> è¯„è®ºç³»ç»Ÿ</p>
<p>ğŸ‡¬ğŸ‡§  ä½ å¯ä»¥ä½¿ç”¨<strong>ä¸­æ–‡ç®€ä½“</strong>æˆ–<strong>è‹±è¯­</strong></p>
<p>ğŸŒ  ä½ å¯ä»¥ä»»æ„ä½¿ç”¨åº”ç”¨å†…é»˜è®¤ä¸»é¢˜æˆ–ä»»æ„ç¬¬ä¸‰æ–¹ä¸»é¢˜ï¼Œå¼ºå¤§çš„ä¸»é¢˜è‡ªå®šä¹‰èƒ½åŠ›</p>
<p>ğŸ–¥  ä½ å¯ä»¥è‡ªå®šä¹‰æºæ–‡ä»¶å¤¹ï¼Œåˆ©ç”¨ OneDriveã€ç™¾åº¦ç½‘ç›˜ã€iCloudã€Dropbox ç­‰è¿›è¡Œå¤šè®¾å¤‡åŒæ­¥</p>
<p>ğŸŒ± å½“ç„¶ <strong>Gridea</strong> è¿˜å¾ˆå¹´è½»ï¼Œæœ‰å¾ˆå¤šä¸è¶³ï¼Œä½†è¯·ç›¸ä¿¡ï¼Œå®ƒä¼šä¸åœå‘å‰ ğŸƒ</p>
<p>æœªæ¥ï¼Œå®ƒä¸€å®šä¼šæˆä¸ºä½ ç¦»ä¸å¼€çš„ä¼™ä¼´</p>
<p>å°½æƒ…å‘æŒ¥ä½ çš„æ‰åå§ï¼</p>
<p>ğŸ˜˜ Enjoy~</p>
]]></content>
    </entry>
</feed>